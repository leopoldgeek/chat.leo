<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  background: url("https://i.postimg.cc/gktF3bZr/Copilot-20250930-144314.png") no-repeat center center fixed;
  background-size: cover;
}
h1,h2 { text-align:center; text-shadow:0 0 8px #0f0; }
input,textarea,button,select {
  margin:6px; padding:10px; background:#001100; color:#0f0;
  border:1px solid #0f0; border-radius:6px;
}
button.spyBtn {
  min-width:160px; padding:12px 20px;
  background:#001100; color:#0f0;
  border:2px solid #0f0; border-radius:8px;
  cursor:pointer;
}
button.spyBtn:hover { background:#0f0; color:#000; }
.row { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
.hidden { display:none; }
.message { border-bottom:1px dashed #0f0; padding:8px; }
img { max-width:100%; margin-top:6px; border:1px solid #0f0; }
#messagesPanel { max-height:65vh; overflow-y:auto; padding:10px; border:1px solid #0f0; }
small.muted { color:#8f8; }
</style>
</head>

<body>
<h1>ğŸ•µï¸ Espion chat</h1>

<!-- Choix rÃ´le -->
<div id="choicePanel" class="row">
  <button class="spyBtn" id="btnChooseAdmin">ğŸ” Admin</button>
  <button class="spyBtn" id="btnChooseUser">ğŸ‘¤ Utilisateur</button>
</div>

<!-- Connexion -->
<div id="loginPanel" class="hidden">
  <h2 id="loginTitle">Connexion</h2>
  <div class="row">
    <input id="loginId" placeholder="Identifiant">
    <input id="loginPwd" type="password" placeholder="Mot de passe">
  </div>
  <p id="captchaQuestion"></p>
  <input id="captchaAnswer" placeholder="RÃ©ponse CAPTCHA">
  <button class="spyBtn" id="btnLogin">Se connecter</button>
  <p id="loginError"></p>
  <div class="row"><button class="spyBtn" id="btnBackLogin">â¬… Retour</button></div>
</div>

<!-- Portail -->
<div id="portalPanel" class="hidden">
  <h2>Centre de contrÃ´le</h2>
  <p style="text-align:center;">
    Bienvenue <span id="userName"></span>
    <small id="userRole" class="muted"></small>
  </p>
  <div class="row">
    <button class="spyBtn" id="btnMessages">ğŸ“¥ Messages</button>
    <button class="spyBtn" id="btnGestion">ğŸ” Comptes</button>
    <button class="spyBtn" id="btnEnvoi">ğŸ“¤ Envoyer</button>
    <button class="spyBtn" id="btnLogout">ğŸšª Quitter</button>
  </div>
</div>

<!-- Messages -->
<div id="messagesPanel" class="hidden">
  <h2>ğŸ“¥ Messages globaux</h2>
  <div id="messages"></div>
  <div class="row"><button class="spyBtn btnBack">â¬… Retour</button></div>
</div>

<!-- Gestion comptes -->
<div id="gestionPanel" class="hidden">
  <h2>ğŸ” Gestion des comptes</h2>
  <div class="row">
    <input id="newId" placeholder="Identifiant">
    <input id="newPwd" placeholder="Mot de passe">
    <select id="newRole">
      <option value="user">Utilisateur</option>
      <option value="admin">Admin</option>
    </select>
    <button class="spyBtn" id="btnCreate">CrÃ©er</button>
  </div>

  <div class="row">
    <select id="accountList"></select>
    <button class="spyBtn" id="btnVoirInfos">ğŸ‘ Voir ID / MDP</button>
    <button class="spyBtn" id="btnDelete">Supprimer</button>
    <button class="spyBtn" id="btnBlock">Bloquer</button>
  </div>

  <div class="row"><button class="spyBtn btnBack">â¬… Retour</button></div>
</div>

<!-- Envoi -->
<div id="envoiPanel" class="hidden">
  <h2>ğŸ“¤ Envoyer</h2>
  <textarea id="msgText" rows="4" placeholder="Message..."></textarea>
  <input type="file" id="imageInput" accept="image/*">
  <img id="preview" style="display:none">
  <button class="spyBtn" id="btnSend">Envoyer</button>
  <p id="sendStatus"></p>
  <div class="row"><button class="spyBtn btnBack">â¬… Retour</button></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient(
  "https://vuymduxdvemtcbbzdqml.supabase.co",
  "sb_publishable_6jCj8B1gHh5v6teJe-zy0g_rf1ijiYJ"
);

const el = id => document.getElementById(id);
const show = id => {
  ["choicePanel","loginPanel","portalPanel","messagesPanel","gestionPanel","envoiPanel"]
  .forEach(p=>el(p).classList.add("hidden"));
  el(id).classList.remove("hidden");
};

let currentUser=null, currentRole=null, roleChoice=null;
let a,b;

function newCaptcha(){
  a=Math.floor(Math.random()*10)+1;
  b=Math.floor(Math.random()*10)+1;
  el("captchaQuestion").textContent=`${a} + ${b} = ?`;
}

el("btnChooseAdmin").onclick=()=>{roleChoice="admin";newCaptcha();show("loginPanel");};
el("btnChooseUser").onclick=()=>{roleChoice="user";newCaptcha();show("loginPanel");};
el("btnBackLogin").onclick=()=>show("choicePanel");

el("btnLogin").onclick=async()=>{
  if(parseInt(el("captchaAnswer").value)!==a+b) return newCaptcha();

  const {data}=await supabase.from("comptes")
    .select("*")
    .eq("identifiant",el("loginId").value)
    .eq("motdepasse",el("loginPwd").value)
    .eq("bloque",false)
    .single();

  if(!data|| (roleChoice==="admin"&&data.role!=="admin")){
    el("loginError").textContent="AccÃ¨s refusÃ©";
    return;
  }

  currentUser=data.identifiant;
  currentRole=data.role;
  el("userName").textContent=currentUser;
  el("userRole").textContent=`(${currentRole})`;
  show("portalPanel");
};

el("btnLogout").onclick=()=>{currentUser=null;show("choicePanel");};

el("btnMessages").onclick=async()=>{
  show("messagesPanel");
  el("messages").innerHTML="";
  const {data}=await supabase.from("messages").select("*").order("created_at",{ascending:false});
  data.forEach(m=>{
    const d=document.createElement("div");
    d.className="message";
    d.innerHTML=`<b>${m.auteur}</b>: ${m.texte}`;
    if(m.image){const i=document.createElement("img");i.src=m.image;d.appendChild(i);}
    el("messages").appendChild(d);
  });
};

el("btnSend").onclick=async()=>{
  await supabase.from("messages").insert({
    auteur:currentUser,
    texte:el("msgText").value,
    image:el("preview").src||null
  });
  el("msgText").value="";
  el("preview").style.display="none";
};

el("btnGestion").onclick=async()=>{
  if(currentRole!=="admin")return;
  show("gestionPanel");
  const {data}=await supabase.from("comptes").select("*");
  el("accountList").innerHTML="";
  data.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id;
    o.textContent=`${c.identifiant} [${c.role}]`;
    el("accountList").appendChild(o);
  });
};

el("btnVoirInfos").onclick=async()=>{
  const {data}=await supabase.from("comptes")
    .select("identifiant,motdepasse")
    .eq("id",el("accountList").value)
    .single();
  alert(`ID: ${data.identifiant}\nMDP: ${data.motdepasse}`);
};

el("btnCreate").onclick=async()=>{
  await supabase.from("comptes").insert({
    identifiant:el("newId").value,
    motdepasse:el("newPwd").value,
    role:el("newRole").value
  });
};

el("btnDelete").onclick=async()=>{
  await supabase.from("comptes").delete().eq("id",el("accountList").value);
};

el("btnBlock").onclick=async()=>{
  const {data}=await supabase.from("comptes").select("bloque")
    .eq("id",el("accountList").value).single();
  await supabase.from("comptes")
    .update({bloque:!data.bloque})
    .eq("id",el("accountList").value);
};

document.querySelectorAll(".btnBack").forEach(b=>b.onclick=()=>show("portalPanel"));
</script>
</body>
</html>

